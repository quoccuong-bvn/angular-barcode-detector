<div class="detector-container">
  <div class="header">
    <h1>Barcode Detector</h1>
    <div class="status">
      <span *ngIf="isModelLoading" class="loading">Loading {{ useMockDetector ? 'Mock' : 'ONNX' }} model...</span>
      <span *ngIf="modelLoaded && !isModelLoading" class="ready">{{ useMockDetector ? 'Mock' : 'ONNX' }} Model ready</span>
      <span *ngIf="error" class="error">{{ error }}</span>
    </div>
    <div class="status">
      <span>COOP/COEP: <strong>{{ crossOriginIsolated ? 'Enabled' : 'Disabled' }}</strong></span>
      <span>WebGL: <strong>{{ webglSupported ? 'Available' : 'Unavailable' }}</strong></span>
      <span>WASM: <strong>{{ wasmSupported ? 'Available' : 'Unavailable' }}</strong></span>
    </div>
    <div class="status" *ngIf="diagnostics">
      <span>Model URL: <strong>{{ diagnostics.modelUrl || '-' }}</strong></span>
      <span>Model size: <strong>{{ diagnostics.modelSizeBytes ? (diagnostics.modelSizeBytes / (1024 * 1024) | number:'1.1-1') + ' MB' : '-' }}</strong></span>
      <span>Backend used: <strong>{{ diagnostics.backendUsed || '-' }}</strong></span>
      <span *ngIf="diagnostics.attempts.length > 0">
        Attempts:
        <strong>{{ getDiagnosticsAttemptsSummary() }}</strong>
      </span>
    </div>
  </div>

  <div class="controls">
    <button 
      (click)="toggleCamera()" 
      [disabled]="!modelLoaded || isModelLoading"
      [class.stop]="isStreaming">
      {{ isStreaming ? 'Stop Camera' : 'Start Camera' }}
    </button>
    <div class="control-row">
      <label class="control-toggle">
        <input type="checkbox" [(ngModel)]="preprocessEnabled" />
        Preprocess (resize + threshold)
      </label>
      <label class="control-select">
        Resolution
        <select [(ngModel)]="cameraResolution" (change)="onCameraResolutionChange()">
          <option *ngFor="let option of cameraResolutionOptions" [value]="option.value">
            {{ option.label }}
          </option>
        </select>
      </label>
    </div>
  </div>

  <div class="stats" *ngIf="isStreaming">
    <div class="stat-item">
      <span class="stat-label">Camera FPS:</span>
      <span class="stat-value">{{ actualCameraFps }}</span>
    </div>
    <div class="stat-item">
      <span class="stat-label">Render FPS:</span>
      <span class="stat-value">{{ fps }}</span>
    </div>
    <div class="stat-item">
      <span class="stat-label">Detections:</span>
      <span class="stat-value" [class.highlight]="detectionCount > 0">{{ detectionCount }}</span>
    </div>
    <div class="stat-item">
      <span class="stat-label">Resolution:</span>
      <span class="stat-value small">{{ currentResolution || '-' }}</span>
    </div>
  </div>

  <div class="video-container">
    <video 
      #videoElement 
      autoplay 
      playsinline 
      muted
      [class.hidden]="!isStreaming">
    </video>
    <canvas 
      #canvasElement
      [class.hidden]="!isStreaming">
    </canvas>
    <div class="decoded-overlay" *ngIf="isStreaming && decodedText">
      <div class="decoded-value">{{ decodedText }}</div>
      <div class="decoded-meta">Format: {{ decodedFormat }}</div>
    </div>
    <div class="status-overlay" *ngIf="isStreaming && streamMessage">
      {{ streamMessage }}
    </div>
    <div
      class="roi-overlay"
      [class.hidden]="!isStreaming"
      style="--roi-top: 25%; --roi-right: 20%; --roi-bottom: 25%; --roi-left: 20%;"
      aria-hidden="true">
    </div>
    <div class="center-crosshair" *ngIf="isStreaming" aria-hidden="true">
      <div class="crosshair-line horizontal"></div>
      <div class="crosshair-line vertical"></div>
      <div class="crosshair-center"></div>
    </div>
  </div>

  <div class="info" *ngIf="!isStreaming && modelLoaded">
    <p>Click "Start Camera" to begin detecting barcodes</p>
    <p>The detector will automatically identify and highlight barcodes in real-time</p>
  </div>
</div>

